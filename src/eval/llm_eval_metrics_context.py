"""Evaluate lexical-overlap thresholds for context paragraph selection.

Input: data/eval/context_qrels_llm.tsv
Generated by: src/eval/llm_eval_judge_context.py

For each threshold t, a paragraph is selected if overlap >= t.
We compute Precision/Recall/F1 over judged paragraphs (binary relevance).
"""

import csv
from collections import defaultdict
from pathlib import Path
from typing import Dict, List, Tuple


INP = Path("data/eval/context_qrels_llm.tsv")


def prf(tp: int, fp: int, fn: int) -> Tuple[float, float, float]:
    p = tp / (tp + fp) if (tp + fp) else 0.0
    r = tp / (tp + fn) if (tp + fn) else 0.0
    f1 = (2 * p * r / (p + r)) if (p + r) else 0.0
    return p, r, f1


def main():
    if not INP.exists():
        raise FileNotFoundError(f"Missing {INP}")

    rows = []
    with INP.open("r", encoding="utf-8") as f:
        rdr = csv.DictReader(f, delimiter="\t")
        for r in rdr:
            rows.append(
                {
                    "obj_kind": r["obj_kind"],
                    "obj_id": r["obj_id"],
                    "overlap": float(r["overlap"]),
                    "rel": int(r["relevance"]),
                }
            )

    thresholds = [round(x / 10.0, 2) for x in range(0, 11)]  # 0.0..1.0
    thresholds += [0.15, 0.25, 0.35, 0.45, 0.55]
    thresholds = sorted(set(thresholds))

    print("\n=== Context overlap threshold sweep (LLM-as-a-Judge) ===")
    for t in thresholds:
        stats = defaultdict(lambda: {"tp": 0, "fp": 0, "fn": 0})

        for r in rows:
            selected = r["overlap"] >= t
            rel = r["rel"] == 1
            kind = r["obj_kind"]
            if selected and rel:
                stats["GLOBAL"]["tp"] += 1
                stats[kind]["tp"] += 1
            elif selected and not rel:
                stats["GLOBAL"]["fp"] += 1
                stats[kind]["fp"] += 1
            elif (not selected) and rel:
                stats["GLOBAL"]["fn"] += 1
                stats[kind]["fn"] += 1

        p, r, f1 = prf(stats["GLOBAL"]["tp"], stats["GLOBAL"]["fp"], stats["GLOBAL"]["fn"])
        print(f"t={t:.2f}  P={p:.3f}  R={r:.3f}  F1={f1:.3f}  (tp={stats['GLOBAL']['tp']} fp={stats['GLOBAL']['fp']} fn={stats['GLOBAL']['fn']})")

    print("\nTip: scegli la soglia che massimizza F1 o quella che ti d√† alta precision con recall accettabile.")


if __name__ == "__main__":
    main()
